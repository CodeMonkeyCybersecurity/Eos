#!/bin/bash

# Ensure the borgbackup directory exists
mkdir -p ~/borgbackup

# Function to log and handle errors
error_exit() {
    echo "$1" 1>&2
    exit 1
}

# Function to check Borg repository connection
check_repo_connection() {
    echo "Checking connection to the Borg repository..."
    borg list "$BORG_REPO" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        error_exit "Unable to connect to the repository at $BORG_REPO. Please check the repository path or your SSH credentials."
    else
        echo "Connection to the Borg repository verified successfully."
    fi
}

# Function to ensure the SSH path is correctly formatted
ensure_ssh_prefix() {
    local path=$1
    if [[ "$path" != ssh://* ]]; then
        path="ssh://$path"
    fi
    echo "$path"
}

# Function to validate time input
validate_time() {
    if ! date -d "$1" "+%H:%M" &> /dev/null; then
        error_exit "Invalid time format: $1"
    fi
}

# Function to validate monthly time input
validate_monthly_time() {
    if ! [[ "$1" =~ ^[0-9]{1,2}(st|nd|rd|th)\ [0-9]{2}:[0-9]{2}$ ]]; then
        error_exit "Invalid monthly time format: $1. Use format like '1st 04:00'."
    fi
}

# Ensure the scripts are executable and exist
if [ ! -x "./scripts/check_ssh_credentials" ]; then
    error_exit "Missing or non-executable check_ssh_credentials script."
fi

if [ ! -x "./scripts/check_borg_repo_path" ]; then
    error_exit "Missing or non-executable check_borg_repo_path script."
fi

# Check SSH credentials
./scripts/check_ssh_credentials || error_exit "SSH credentials check failed."

# Check Borg repository path
./scripts/check_borg_repo_path || error_exit "Repository path check failed."

# Prompt the user for BORG_REPO path
read -p "Enter the BORG_REPO path (e.g., /mnt/borg-repo or ssh://username@host:/path/to/repo): " BORG_REPO

# Ensure the correct SSH format
BORG_REPO=$(ensure_ssh_prefix "$BORG_REPO")

# Check the connection to the Borg repository
check_repo_connection "$BORG_REPO"

# If the connection is successful, proceed to ask for the passphrase
read -sp "Enter the BORG_PASSPHRASE (hidden input): " BORG_PASSPHRASE
echo

# Continue with the rest of the script
read -p "Enter the number of daily backups to keep: " KEEP_DAILY
read -p "Enter the number of weekly backups to keep: " KEEP_WEEKLY
read -p "Enter the number of monthly backups to keep: " KEEP_MONTHLY

# Validate time inputs
read -p "Enter the daily backup time (in 24-hour format, e.g., 02:00): " BACKUP_TIME_DAILY
validate_time "$BACKUP_TIME_DAILY"

read -p "Enter the weekly backup day and time (e.g., Sun 03:00 in 24-hour format): " BACKUP_TIME_WEEKLY
validate_time "$BACKUP_TIME_WEEKLY"

read -p "Enter the monthly backup day and time (e.g., 1st 04:00 in format '1st 04:00'): " BACKUP_TIME_MONTHLY
validate_monthly_time "$BACKUP_TIME_MONTHLY"

read -p "Enter the hostname of the environment (e.g., $(hostname)): " HOSTNAME
OS_INFO=$(lsb_release -d | cut -f2)
read -p "Enter the important directories to backup (default: /etc /home /root /var): " IMPORTANT_DIRS
IMPORTANT_DIRS=${IMPORTANT_DIRS:-/etc /home /root /var}

# Handle multiple directories with commas
IMPORTANT_DIRS=$(echo "$IMPORTANT_DIRS" | tr ',' ' ')

read -p "Enter any known issues or considerations (optional): " KNOWN_ISSUES
read -p "Enter contact information (e.g., First Last, your@email.net.au): " CONTACT_INFO

# Create a configuration file in markdown format
CONFIG_FILE=~/borgbackup/borg_configs.md

cat << EOF > $CONFIG_FILE
# BorgBackup Configuration

## Repository Path
\`\`\`
BORG_REPO=${BORG_REPO}
\`\`\`

## Passphrase
\`\`\`
BORG_PASSPHRASE=${BORG_PASSPHRASE}
\`\`\`

## Retention Policy
- **Daily backups** to keep: ${KEEP_DAILY}
- **Weekly backups** to keep: ${KEEP_WEEKLY}
- **Monthly backups** to keep: ${KEEP_MONTHLY}

## Backup Schedule
- **Daily** at ${BACKUP_TIME_DAILY}
- **Weekly** on ${BACKUP_TIME_WEEKLY}
- **Monthly** on ${BACKUP_TIME_MONTHLY}

## Retention Strategy Justification
- **Daily backups**: Retain for ${KEEP_DAILY} days to ensure recent data is easily recoverable.
- **Weekly backups**: Retain for ${KEEP_WEEKLY} weeks to cover a typical work month.
- **Monthly backups**: Retain for ${KEEP_MONTHLY} months to allow for medium-term historical data recovery.

## Repository Information
- **Location**: ${BORG_REPO}
- **Remote Access**: ${BORG_REPO}
- **Encryption**: Enabled using \`repokey\`

## Environment Information
- **Hostname**: ${HOSTNAME}
- **Operating System**: ${OS_INFO}
- **Important Directories**: ${IMPORTANT_DIRS}

## Known Issues/Considerations
${KNOWN_ISSUES:-None}

## Contact Information
- **Maintainer**: ${CONTACT_INFO}

## Last Backup Status
- **Last Successful Backup**: N/A
- **Last Failure**: N/A

## Commands and Execution Notes
- **Backup Command**: \`borg create --verbose --filter AME --list --compression lz4 --exclude-caches --exclude 'home/*/.cache/*' --exclude 'var/tmp/*' "$BORG_REPO::'{hostname}-{now}'" ${IMPORTANT_DIRS}\`
- **Execution Notes**: Ensure that all dependencies are installed before running the script.
EOF

echo "Configuration has been saved to $CONFIG_FILE"

# Export the variables so they can be used in the backup script
export BORG_REPO
export BORG_PASSPHRASE

# Convert backup times to crontab format (24-hour)
convert_time_to_24hr_format() {
    time_input="$1"
    date -d "$time_input" +'%H:%M'
}

daily_time=$(convert_time_to_24hr_format "$BACKUP_TIME_DAILY")
weekly_time=$(convert_time_to_24hr_format "$BACKUP_TIME_WEEKLY")
monthly_time=$(convert_time_to_24hr_format "${BACKUP_TIME_MONTHLY:4}") # Extract time part only

# Add BorgBackup operations to crontab
(crontab -l 2>/dev/null; echo "0 ${daily_time%%:*} * * * ~/borgbackup/backup_script.sh > ~/borgbackup/backup.log 2>&1") | crontab -
(crontab -l 2>/dev/null; echo "0 ${weekly_time%%:*} * * ${weekly_time%% *} ~/borgbackup/backup_script.sh > ~/borgbackup/backup.log 2>&1") | crontab -
(crontab -l 2>/dev/null; echo "0 ${monthly_time%%:*} ${BACKUP_TIME_MONTHLY:0:2} * * ~/borgbackup/backup_script.sh > ~/borgbackup/backup.log 2>&1") | crontab -

echo "BorgBackup operations have been added to crontab."
